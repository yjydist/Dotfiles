import{D as e,K as t,P as n,xt as r}from"./DO0JR7ER.js";import{a as i}from"./CnEnsHnL.js";import{t as a}from"./CNdGjGfk.js";import{t as o}from"./Dc30IiQz.js";import{c as s,d as c,f as l,i as u,m as d,p as f,s as p,u as m}from"./Ch85hcd-.js";var h=typeof global==`object`&&global&&global.Object===Object&&global,g=typeof self==`object`&&self&&self.Object===Object&&self,_=h||g||Function(`return this`)(),v=_.Symbol,y=Object.prototype,b=y.hasOwnProperty,x=y.toString,S=v?v.toStringTag:void 0;function C(e){var t=b.call(e,S),n=e[S];try{e[S]=void 0;var r=!0}catch{}var i=x.call(e);return r&&(t?e[S]=n:delete e[S]),i}var w=C,T=Object.prototype.toString;function E(e){return T.call(e)}var D=E,O=`[object Null]`,k=`[object Undefined]`,A=v?v.toStringTag:void 0;function j(e){return e==null?e===void 0?k:O:A&&A in Object(e)?w(e):D(e)}var M=j;function N(e){return typeof e==`object`&&!!e}var P=N,F=`[object Number]`;function I(e){return typeof e==`number`||P(e)&&M(e)==F}var L=I;const R=n(`proxies`,()=>{let t=a(),n=z(),i=r([]),o=r([]),h=r({}),g=r({}),_=r({}),v=r({}),y=r({}),b=r({}),x=r(!1),S=e(`collapsedMap`,{}),C=(e,n=!0)=>{let r=e.extra||{},i=Object.keys(r).reduce((e,n)=>{let i=r[n],a=i?.history?.at(-1)?.delay??t.latencyQualityMap.NOT_CONNECTED;return e.allTestUrlLatency[n]=a,e.allTestUrlLatencyHistory[n]=i?.history,e},{allTestUrlLatency:{},allTestUrlLatencyHistory:{}});if(n){let n=e.testUrl||t.urlForLatencyTest;if(!(n in i.allTestUrlLatency)){let r=e.history?.at(-1)?.delay??t.latencyQualityMap.NOT_CONNECTED;i.allTestUrlLatency[n]=r,i.allTestUrlLatencyHistory[n]=e.history}}return i},w=e=>{let n={...g.value},r={...h.value};e.forEach(e=>{let{allTestUrlLatency:i,allTestUrlLatencyHistory:a}=C(e),{udp:o,xudp:s,type:c,now:l,name:u,tfo:d,provider:f=``}=e;n[e.name]={udp:o,xudp:s,type:c,latency:l,latencyTestHistory:a,name:u,tfo:d,provider:f},(Object.values(i).some(e=>e!==t.latencyQualityMap.NOT_CONNECTED)||!r[e.name])&&(r[e.name]=i)}),g.value=n,h.value=r},T=async()=>{let[{providers:e},{proxies:t}]=await Promise.all([s(),p()]),n=Object.values(t).map(t=>{if(t.all?.length&&!t.testUrl){let{testUrl:n,timeout:r}=e?.[t.name]||{};return{...t,testUrl:n,timeout:r}}return t}),r=[...t.GLOBAL?.all??[],`GLOBAL`],a=Object.values(n).filter(e=>e.all?.length).sort((e,t)=>r.indexOf(e.name)-r.indexOf(t.name)),c=Object.values(e).filter(e=>e.name!==`default`&&e.vehicleType!==`Compatible`),l=[...n,...c.flatMap(e=>e.proxies.filter(e=>!(e.name in t)).map(t=>({...t,provider:e.name})))];i.value=a,o.value=c,w(l)},E=async(e,r)=>{if(await f(e.name,r),await T(),t.autoCloseConns){let t=n.restructRawMsgToConnection(n.latestConnectionMsg?.connections??[],[]);t.length>0&&t.forEach(({id:t,chains:n})=>{n.includes(e.name)&&u(t)})}},D=e=>{let t=g.value[e];if(!e||!t)return e;for(;t&&t.latency&&t.latency!==t.name;){let e=g.value[t.latency];if(!e)return t.name;t=e}return t?.name??e};return{proxies:i,proxyProviders:o,latencyMap:h,proxyNodeMap:g,proxyLatencyTestingMap:_,proxyGroupLatencyTestingMap:v,proxyProviderLatencyTestingMap:y,updatingMap:b,isAllProviderUpdating:x,collapsedMap:S,fetchProxies:T,selectProxyInGroup:E,getNowProxyNodeName:D,getLatencyByName:(e,n)=>{let r=n||t.urlForLatencyTest,i=h.value,a=D(e),o=i[a]?.[r],s=i[e]?.[r];if(o!=null)return o;if(s!=null)return s;let c=i[a];if(c&&Object.keys(c).length>0){let e=Object.keys(c),t=c[r]==null?e[0]:r;if(t)return c[t]}let l=i[e];if(l&&Object.keys(l).length>0){let e=Object.keys(l);if(e[0])return l[e[0]]}return t.latencyQualityMap.NOT_CONNECTED},getLatencyHistoryByName:(e,n)=>{let r=g.value[e],i=D(e),a=g.value[i],o=n||t.urlForLatencyTest,s=a?.latencyTestHistory[o]||r?.latencyTestHistory[o];if(s&&s.length)return s;let c=a?.latencyTestHistory||{},l=Object.keys(c)[0];if(l){let e=c[l];if(e&&e.length)return e}let u=r?.latencyTestHistory||{},d=Object.keys(u)[0];if(d){let e=u[d];if(e&&e.length)return e}return[]},isProxyGroup:e=>{let t=g.value[e];return t?[`direct`,`reject`,`loadbalance`].includes(t.type.toLowerCase())||!!t.latency:!1},proxyLatencyTest:async(e,n,r,i)=>{let a=D(e);_.value[a]=!0;try{let e=r||t.urlForLatencyTest,o=h.value?.[a]||{},{delay:s}=await c(a,n,e,i??t.latencyTestTimeoutDuration);o[e]=s,h.value={...h.value,[a]:o}}catch{let e=r||t.urlForLatencyTest,n=h.value?.[a]||{};n[e]=t.latencyQualityMap.NOT_CONNECTED,h.value={...h.value,[a]:n}}finally{_.value[a]=!1}},proxyGroupLatencyTest:async e=>{v.value[e]=!0;try{let n=i.value.find(t=>t.name===e);await m(e,n?.testUrl||t.urlForLatencyTest,n?.timeout??t.latencyTestTimeoutDuration),await T()}finally{v.value[e]=!1}},updateProviderByProviderName:async e=>{b.value[e]=!0;try{await d(e)}catch{}await T(),b.value[e]=!1},updateAllProvider:async()=>{x.value=!0;try{await Promise.allSettled(o.value.map(e=>d(e.name))),await T()}finally{x.value=!1}},proxyProviderLatencyTest:async e=>{y.value[e]=!0;try{await l(e),await T()}finally{y.value[e]=!1}}}}),z=n(`connections`,()=>{let n=o(),i=r([]),a=r([]),s=r([]),c=r(null),l=r(!1),u=e(`dataUsageMap`,{sourceIP:{},host:{},process:{},outbound:{}}),d=e(`dataUsageBaseline`,{upload:0,download:0}),f=0,p=0,m=new Map,h=!1,g=(e,t)=>{let n=new Map;return t.forEach(e=>n.set(e.id,e)),e.map(e=>{let t=n.get(e.id);if(!t||!L(t.download)||!L(t.upload)){let t=e;return{...e,downloadSpeed:t.downloadSpeed??0,uploadSpeed:t.uploadSpeed??0}}return{...e,downloadSpeed:e.download-t.download,uploadSpeed:e.upload-t.upload}})},_=e=>{let t=new Set,n=[];for(let e of i.value)t.has(e.id)||(t.add(e.id),n.push(e));for(let r of e)t.has(r.id)||(t.add(r.id),n.push(r));let r=e.length+200;i.value=r>0&&n.length>r?n.slice(-r):n},v=(e,t)=>{let n=new Set(e.map(e=>e.id));return t.filter(e=>!n.has(e.id))},y=()=>{m.clear(),d.value={upload:0,download:0},h=!1,console.log(`[Data Usage] Connection tracking reset due to service restart`)},b=()=>{u.value={sourceIP:{},host:{},process:{},outbound:{}},m.clear()},x=(e,t)=>{let n={...u.value},r={...n[e]};delete r[t],n[e]=r,u.value=n},S=e=>{let t=e?new Set(e.map(e=>e.id)):new Set(i.value.map(e=>e.id));m.forEach((e,n)=>{t.has(n)||m.delete(n)})},C=e=>{c.value=e;let t=e?.connections,r=e?.uploadTotal||0,o=e?.downloadTotal||0;if((r<f||o<p)&&(y(),b(),n.clearChartHistory()),f=r,p=o,!t||t.length===0)return;let u=g(t,a.value);if(w(u),S(u),_(u),!l.value){let e=v(u,i.value);a.value=u,s.value=e.slice(-200)}},w=e=>{let t=c.value;t?.uploadTotal,t?.downloadTotal,h||=!0;let n={...u.value},r=Date.now(),i={sourceIP:new Map,host:new Map,process:new Map,outbound:new Map};e.forEach(e=>{let t=e.upload||0,n=e.download||0,r=0,a=0,o=m.get(e.id);if(o?(r=Math.max(0,t-o.upload),a=Math.max(0,n-o.download)):(r=t,a=n),m.set(e.id,{upload:t,download:n}),r===0&&a===0)return;let s=(e,t)=>{if(!t)return;i[e].has(t)||i[e].set(t,{upload:0,download:0});let n=i[e].get(t);n.upload+=r,n.download+=a};s(`sourceIP`,e.metadata.sourceIP||`Inner`),s(`host`,e.metadata.host||e.metadata.destinationIP),s(`process`,e.metadata.process||`Unknown`),s(`outbound`,e.chains&&e.chains.length>0?e.chains[0]:`DIRECT`)}),Object.keys(i).forEach(e=>{let t=i[e],a={...n[e]},o=!1;t.forEach((t,n)=>{o=!0;let i=a[n];i?a[n]={...i,upload:i.upload+t.upload,download:i.download+t.download,total:i.upload+t.upload+(i.download+t.download),lastSeen:r}:a[n]={type:e,label:n,upload:t.upload,download:t.download,total:t.upload+t.download,firstSeen:r,lastSeen:r}}),o&&(n[e]=a)}),u.value=n};return{allConnections:i,activeConnections:a,closedConnections:s,latestConnectionMsg:c,paused:l,dataUsageMap:u,speedGroupByName:t(()=>{let e=R(),t={};return a.value.forEach(n=>{n.chains.forEach(r=>{e.isProxyGroup(r)||(t[r]||(t[r]=0),t[r]+=n.downloadSpeed)})}),t}),updateFromWsMsg:C,clearDataUsage:b,removeDataUsageEntry:x,restructRawMsgToConnection:g}});var B={},V=new WeakMap,H={metric:[{from:0,to:1e3,unit:`B`,long:`bytes`},{from:1e3,to:1e6,unit:`kB`,long:`kilobytes`},{from:1e6,to:1e9,unit:`MB`,long:`megabytes`},{from:1e9,to:0xe8d4a51000,unit:`GB`,long:`gigabytes`},{from:0xe8d4a51000,to:0x38d7ea4c68000,unit:`TB`,long:`terabytes`},{from:0x38d7ea4c68000,to:0xde0b6b3a7640000,unit:`PB`,long:`petabytes`},{from:0xde0b6b3a7640000,to:1e21,unit:`EB`,long:`exabytes`},{from:1e21,to:1e24,unit:`ZB`,long:`zettabytes`},{from:1e24,to:1e27,unit:`YB`,long:`yottabytes`}],metric_octet:[{from:0,to:1e3,unit:`o`,long:`octets`},{from:1e3,to:1e6,unit:`ko`,long:`kilooctets`},{from:1e6,to:1e9,unit:`Mo`,long:`megaoctets`},{from:1e9,to:0xe8d4a51000,unit:`Go`,long:`gigaoctets`},{from:0xe8d4a51000,to:0x38d7ea4c68000,unit:`To`,long:`teraoctets`},{from:0x38d7ea4c68000,to:0xde0b6b3a7640000,unit:`Po`,long:`petaoctets`},{from:0xde0b6b3a7640000,to:1e21,unit:`Eo`,long:`exaoctets`},{from:1e21,to:1e24,unit:`Zo`,long:`zettaoctets`},{from:1e24,to:1e27,unit:`Yo`,long:`yottaoctets`}],iec:[{from:0,to:1024**1,unit:`B`,long:`bytes`},{from:1024**1,to:1024**2,unit:`KiB`,long:`kibibytes`},{from:1024**2,to:1024**3,unit:`MiB`,long:`mebibytes`},{from:1024**3,to:1024**4,unit:`GiB`,long:`gibibytes`},{from:1024**4,to:1024**5,unit:`TiB`,long:`tebibytes`},{from:1024**5,to:1024**6,unit:`PiB`,long:`pebibytes`},{from:1024**6,to:1024**7,unit:`EiB`,long:`exbibytes`},{from:1024**7,to:1024**8,unit:`ZiB`,long:`zebibytes`},{from:1024**8,to:1024**9,unit:`YiB`,long:`yobibytes`}],iec_octet:[{from:0,to:1024**1,unit:`o`,long:`octets`},{from:1024**1,to:1024**2,unit:`Kio`,long:`kibioctets`},{from:1024**2,to:1024**3,unit:`Mio`,long:`mebioctets`},{from:1024**3,to:1024**4,unit:`Gio`,long:`gibioctets`},{from:1024**4,to:1024**5,unit:`Tio`,long:`tebioctets`},{from:1024**5,to:1024**6,unit:`Pio`,long:`pebioctets`},{from:1024**6,to:1024**7,unit:`Eio`,long:`exbioctets`},{from:1024**7,to:1024**8,unit:`Zio`,long:`zebioctets`},{from:1024**8,to:1024**9,unit:`Yio`,long:`yobioctets`}]},U=class{constructor(e,t){t=Object.assign({units:`metric`,precision:1,locale:void 0},B,t),V.set(this,t),Object.assign(H,t.customUnits);let n=e<0?`-`:``;e=Math.abs(e);let r=H[t.units];if(r){let i=r.find(t=>e>=t.from&&e<t.to);if(i){let r=new Intl.NumberFormat(t.locale,{style:`decimal`,maximumFractionDigits:t.precision});this.value=i.from===0?n+r.format(e):n+r.format(e/i.from),this.unit=i.unit,this.long=i.long}else this.value=n+e,this.unit=``,this.long=``}else throw Error(`Invalid units specified: ${t.units}`)}toString(){let e=V.get(this);return e.toStringFn?e.toStringFn.bind(this)():`${this.value} ${this.unit}`}};function W(e,t){return new U(e,t)}W.defaultOptions=function(e){B=e};var G=W;export{_ as a,M as i,z as n,R as r,G as t};